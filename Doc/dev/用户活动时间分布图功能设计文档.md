# 用户活动时间分布图功能设计文档

## 功能概述

实现用户活动时间分布图的统计接口，用于前端绘制用户活跃时间段的可视化图表。

## 需求分析

### 核心需求
- 统计每个用户的活动时间段（启动时间分布）
- 以4点为分界线处理跨天的时间区间
- 返回用户活动时间区间数据供前端绘制图表

### 特殊处理逻辑
- 4点作为分界线：如果用户的活动时间跨越4点，需要特殊处理
- 例如：用户6点启动，3点启动，活动区间为6:00-3:00（跨天）
- 需要处理最小时间和最大时间的计算逻辑

## 技术设计

### 数据结构设计

#### 新增数据结构
```kotlin
/**
 * 用户活动时间区间
 */
data class UserActivityTimeRange(
    var userName: String = "",
    var earliestStartTime: LocalDateTime? = null,  // 最早启动时间
    var latestStartTime: LocalDateTime? = null,    // 最晚启动时间
    var activityTimeRange: String = "",            // 活动时间区间字符串
    var totalTasks: Int = 0,                       // 总任务数
    var totalRuntime: Int = 0                      // 总运行时间
)

/**
 * 用户活动时间分布响应
 */
data class UserActivityTimeDistribution(
    var users: List<UserActivityTimeRange> = emptyList(),
    var totalUsers: Int = 0,
    var refreshTime: LocalDateTime = LocalDateTime.now()
)
```

### 接口设计

#### 新增接口方法
在 `BaseStatisticsService` 接口中添加：
```kotlin
/**
 * 获取用户活动时间分布（无缓存）
 * @param tasks 任务列表
 * @param startTime 开始时间（秒，可选）
 * @param endTime 结束时间（秒，可选）
 * @return 用户活动时间分布
 */
fun getUserActivityTimeDistribution(
    tasks: List<GpuTaskInfoModel>, 
    startTime: Long? = null, 
    endTime: Long? = null
): UserActivityTimeDistribution
```

#### API接口设计
新增控制器方法：
- 路径：`/api/statistics/user-activity-time-distribution`
- 方法：GET
- 参数：`startTime`、`endTime`（可选）
- 响应：`UserActivityTimeDistribution`

### 核心算法设计

#### 时间区间计算逻辑
1. **收集所有启动时间**：从任务列表中提取每个用户的启动时间
2. **处理4点分界线**：
   - 如果所有时间都在4点之后，正常计算最小最大时间
   - 如果所有时间都在4点之前，正常计算最小最大时间
   - 如果时间跨越4点，需要特殊处理跨天区间
3. **跨天区间处理**：
   - 将4点之前的时间视为"第二天"的时间
   - 例如：6:00和3:00，3:00视为第二天的3:00
   - 计算区间为6:00-27:00（即第二天的3:00）

#### 实现步骤
1. 按用户分组，收集所有启动时间
2. 对每个用户的启动时间进行排序
3. 判断是否跨越4点分界线
4. 计算活动时间区间
5. 格式化输出时间区间字符串

## 实现计划

### 阶段一：数据结构定义
- 在 `StatisticsModels.kt` 中新增数据结构
- 确保与现有统计系统兼容

### 阶段二：服务层实现
- 在 `StatisticsAnalyzer` 中实现核心算法
- 在 `StatisticsServiceImpl` 中实现接口方法

### 阶段三：控制器层实现
- 新增API控制器方法
- 添加Swagger注解说明特殊逻辑

### 阶段四：测试验证
- 验证跨天时间区间计算
- 验证正常时间区间计算
- 验证空数据情况处理

## 注意事项

### 时间处理
- 使用 `LocalDateTime` 处理时间，避免时区问题
- 4点分界线需要特殊处理逻辑
- 时间格式化需要统一格式

### 性能考虑
- 大数据量时的性能优化
- 避免重复计算
- 考虑添加缓存机制

### 前端对接
- 提供清晰的时间区间格式
- 支持空数据情况
- 提供完整的用户信息

## 风险评估

1. **跨天时间计算复杂度**：需要仔细处理4点分界线逻辑
2. **数据一致性**：确保与现有统计系统数据一致
3. **性能问题**：大数据量时可能需要优化

## 验收标准

- [ ] 能够正确计算用户活动时间区间
- [ ] 正确处理跨4点的时间区间
- [ ] 返回数据格式符合前端需求
- [ ] 接口性能满足要求
- [ ] 与现有统计系统兼容