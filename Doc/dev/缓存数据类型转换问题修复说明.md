# ç¼“å­˜æ•°æ®ç±»å‹è½¬æ¢é—®é¢˜ä¿®å¤è¯´æ˜

## é—®é¢˜æè¿°

åœ¨è¿è¡Œè¿‡ç¨‹ä¸­å‡ºç°ä»¥ä¸‹è­¦å‘Šä¿¡æ¯ï¼š
```
2025-10-10 14:02:59.302 [http-nio-15090-exec-9] WARN  c.k.g.c.s.cache.ReportCacheManager - âš ï¸ Memory cache contains unexpected data type for key: gpu_stats_ONE_WEEK, type: com.alibaba.fastjson2.JSONArray
```

## é—®é¢˜åˆ†æ

### æ ¹æœ¬åŸå› 
1. **ç¼“å­˜å­˜å‚¨æµç¨‹**ï¼šåœ¨ [`CachedStatisticsService.kt`](../src/main/kotlin/com/khm/group/center/service/CachedStatisticsService.kt) ä¸­ï¼Œç»Ÿè®¡æ•°æ®ï¼ˆå¦‚ `List<GpuStatistics>`ï¼‰è¢«æ­£ç¡®å­˜å‚¨åˆ°å†…å­˜ç¼“å­˜ä¸­
2. **ç£ç›˜åºåˆ—åŒ–**ï¼šå½“æ•°æ®è¢«æŒä¹…åŒ–åˆ°ç£ç›˜æ—¶ï¼Œä½¿ç”¨ FastJSON è¿›è¡Œåºåˆ—åŒ–
3. **ååºåˆ—åŒ–é—®é¢˜**ï¼šä»ç£ç›˜åŠ è½½ç¼“å­˜æ•°æ®æ—¶ï¼ŒFastJSON å¯èƒ½å°†åˆ—è¡¨ååºåˆ—åŒ–ä¸º `JSONArray` è€Œä¸æ˜¯å…·ä½“çš„ç±»å‹åŒ–åˆ—è¡¨
4. **ç±»å‹æ£€æŸ¥ä¸åŒ¹é…**ï¼šåœ¨ [`ReportCacheManager.kt`](../src/main/kotlin/com/khm/group/center/service/cache/ReportCacheManager.kt) çš„ç±»å‹æ£€æŸ¥ä¸­ï¼Œåªæ£€æŸ¥äº†å…·ä½“çš„ç±»å‹åŒ–åˆ—è¡¨ï¼Œæ²¡æœ‰å¤„ç† `JSONArray` ç±»å‹

### å½±å“èŒƒå›´
- `gpu_stats_*` ç¼“å­˜é”®
- `user_stats_*` ç¼“å­˜é”®  
- `server_stats_*` ç¼“å­˜é”®
- `project_stats_*` ç¼“å­˜é”®

## è§£å†³æ–¹æ¡ˆ

### 1. å¢å¼ºç±»å‹æ£€æŸ¥é€»è¾‘
åœ¨ [`ReportCacheManager.getCachedData()`](../src/main/kotlin/com/khm/group/center/service/cache/ReportCacheManager.kt) æ–¹æ³•ä¸­æ·»åŠ äº†å¯¹ `JSONArray` ç±»å‹çš„å¤„ç†ï¼š

```kotlin
} else if (data is com.alibaba.fastjson2.JSONArray) {
    // å¤„ç†ä»ç£ç›˜ååºåˆ—åŒ–æ—¶å¯èƒ½å‡ºç°çš„JSONArrayç±»å‹
    logger.debug("ğŸ”„ Converting JSONArray to appropriate list type for key: $cacheKey")
    val convertedData = convertJsonArrayToTypedList(data, cacheKey)
    if (convertedData != null) {
        // æ›´æ–°å†…å­˜ç¼“å­˜ä¸­çš„æ•°æ®ç±»å‹
        memoryCache[cacheKey] = CacheEntry(convertedData as Any, memoryEntry.timestamp, memoryEntry.expiryTime)
        return convertedData as T
    } else {
        logger.warn("âš ï¸ Failed to convert JSONArray for key: $cacheKey, type: ${data.javaClass.name}")
        memoryCache.remove(cacheKey)
    }
}
```

### 2. æ·»åŠ ç±»å‹è½¬æ¢æ–¹æ³•
æ–°å¢ `convertJsonArrayToTypedList()` æ–¹æ³•ï¼Œæ ¹æ®ç¼“å­˜é”®å‰ç¼€å°† `JSONArray` è½¬æ¢ä¸ºç›¸åº”çš„ç±»å‹åŒ–åˆ—è¡¨ï¼š

```kotlin
private fun convertJsonArrayToTypedList(jsonArray: com.alibaba.fastjson2.JSONArray, cacheKey: String): Any? {
    return try {
        when {
            cacheKey.startsWith("user_stats") -> {
                // è½¬æ¢ä¸º List<UserStatistics>
            }
            cacheKey.startsWith("gpu_stats") -> {
                // è½¬æ¢ä¸º List<GpuStatistics>
            }
            cacheKey.startsWith("server_stats") -> {
                // è½¬æ¢ä¸º List<ServerStatistics>
            }
            cacheKey.startsWith("project_stats") -> {
                // è½¬æ¢ä¸º List<ProjectStatistics>
            }
            else -> null
        }
    } catch (e: Exception) {
        logger.error("Failed to convert JSONArray for key: $cacheKey", e)
        null
    }
}
```

## ä¿®å¤æ•ˆæœ

1. **æ¶ˆé™¤è­¦å‘Š**ï¼šä¸å†å‡ºç° "unexpected data type" è­¦å‘Š
2. **æ•°æ®å®Œæ•´æ€§**ï¼šç¡®ä¿ç¼“å­˜æ•°æ®èƒ½å¤Ÿæ­£ç¡®æ¢å¤å’Œä½¿ç”¨
3. **æ€§èƒ½ä¼˜åŒ–**ï¼šé¿å…å› ç±»å‹ä¸åŒ¹é…å¯¼è‡´çš„ç¼“å­˜å¤±æ•ˆå’Œé‡æ–°è®¡ç®—
4. **å‘åå…¼å®¹**ï¼šä¸å½±å“ç°æœ‰çš„ç¼“å­˜æ•°æ®

## æµ‹è¯•éªŒè¯

æ„å»ºæµ‹è¯•é€šè¿‡ï¼Œæ‰€æœ‰52ä¸ªæµ‹è¯•ç”¨ä¾‹å‡æˆåŠŸæ‰§è¡Œï¼ŒåŒ…æ‹¬ç¼“å­˜ç›¸å…³çš„æµ‹è¯•ç”¨ä¾‹ã€‚

## é¢„é˜²æªæ–½

1. **ç±»å‹å®‰å…¨**ï¼šåœ¨ç¼“å­˜å­˜å‚¨å’Œæ£€ç´¢æ—¶ç¡®ä¿ç±»å‹ä¸€è‡´æ€§
2. **é”™è¯¯å¤„ç†**ï¼šå¯¹ååºåˆ—åŒ–è¿‡ç¨‹ä¸­çš„å¼‚å¸¸æƒ…å†µè¿›è¡Œé€‚å½“å¤„ç†
3. **æ—¥å¿—è®°å½•**ï¼šè¯¦ç»†è®°å½•ç±»å‹è½¬æ¢è¿‡ç¨‹ï¼Œä¾¿äºé—®é¢˜æ’æŸ¥
4. **ç¼“å­˜æ¸…ç†**ï¼šå¯¹æ— æ³•è½¬æ¢çš„æ•°æ®è‡ªåŠ¨æ¸…ç†ï¼Œé¿å…æ±¡æŸ“ç¼“å­˜

## ç›¸å…³æ–‡ä»¶

- [`ReportCacheManager.kt`](../src/main/kotlin/com/khm/group/center/service/cache/ReportCacheManager.kt) - ä¸»è¦ä¿®å¤æ–‡ä»¶
- [`CachedStatisticsService.kt`](../src/main/kotlin/com/khm/group/center/service/CachedStatisticsService.kt) - ç¼“å­˜ä½¿ç”¨æ–‡ä»¶
- [`StatisticsModels.kt`](../src/main/kotlin/com/khm/group/center/datatype/statistics/StatisticsModels.kt) - ç»Ÿè®¡æ•°æ®ç±»å‹å®šä¹‰