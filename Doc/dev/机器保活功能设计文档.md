# 机器保活功能设计文档

## 功能概述

为Group Center系统添加机器保活功能，包括：
1. 定期ping每个machine，更新成功ping的时间
2. 提供agent保活的API，模仿显卡脚本推送通知的API设计
3. 时间戳对比，如果时间相差较多则log输出需要更新时间
4. 提供API返回每台机器的ping和agent客户端心跳保活状态

## 功能需求分析

### 1. 定期ping功能
- 定期对每个machine进行ping检测
- 更新成功ping的时间戳
- 默认ping时间为null

### 2. Agent保活API
- 模仿现有的显卡脚本推送通知API设计
- 需要带token发送心跳包
- 验证token有效性
- 更新收到心跳的时间戳
- 时间戳对比，如果时间相差较多则log输出警告

### 3. 状态查询API
- 提供API返回每台机器的ping状态
- 返回agent客户端心跳保活状态（最后一次成功的时间）

## 技术设计

### 数据结构扩展

#### MachineConfig扩展
```kotlin
class MachineConfig : MachineBaseConfig() {
    // 现有字段...
    
    // 新增保活相关字段
    var lastPingTime: Long? = null  // 最后一次成功ping的时间戳
    var lastHeartbeatTime: Long? = null  // 最后一次agent心跳时间戳
    var pingStatus: Boolean = false  // 当前ping状态
    var agentStatus: Boolean = false  // agent在线状态
}
```

### API设计

#### 1. Agent心跳API
- 路径：`/api/client/heartbeat`
- 方法：POST
- 请求体：包含时间戳和token
- 响应：标准ClientResponse

#### 2. 机器状态查询API
- 路径：`/api/machine/status`
- 方法：GET
- 响应：包含所有机器状态信息的列表

### 定时任务设计

#### Ping定时任务
- 使用Spring的@Scheduled注解
- 定期执行ping检测
- 更新机器状态

## 实现计划

### 第一阶段：数据结构扩展
1. 扩展MachineConfig类，添加保活相关字段
2. 更新MachineConfigParser，支持新字段

### 第二阶段：API实现
1. 实现Agent心跳API
2. 实现机器状态查询API

### 第三阶段：定时任务实现
1. 实现ping定时任务
2. 添加时间戳验证逻辑

### 第四阶段：日志和监控
1. 添加详细的日志输出
2. 实现时间戳对比警告机制

## 安全考虑

- 使用现有的ClientAccessKey机制进行token验证
- 验证时间戳的有效性，防止重放攻击
- 记录客户端IP地址用于审计

## 性能考虑

- ping检测使用异步执行，避免阻塞主线程
- 心跳API响应时间要快，避免影响客户端
- 状态查询API使用缓存机制提高性能

## 测试计划

1. 单元测试：测试API接口和业务逻辑
2. 集成测试：测试完整的保活流程
3. 性能测试：测试高并发下的性能表现

## 部署计划

1. 更新配置文件格式（向后兼容）
2. 部署新版本
3. 监控系统运行状态
4. 收集用户反馈进行优化