# 代理服务器配置功能设计文档

## 1. 功能概述

本功能旨在为Group Center系统添加代理服务器配置和管理能力，支持HTTP、HTTPS和SOCKS5代理协议，并提供代理服务器健康状态监控和查询接口。

## 2. 功能需求

### 2.1 核心功能
- 支持配置多个代理服务器
- 支持HTTP、HTTPS、SOCKS5代理协议
- 默认HTTPS代理，HTTP未配置时使用HTTPS
- 定期健康检查（访问Google、YouTube等被墙网站）
- 提供REST API查询代理服务器状态

### 2.2 配置要求
- 使用YAML格式配置文件
- 支持代理服务器认证（用户名/密码）
- 支持代理服务器优先级配置
- 支持代理服务器启用/禁用状态

## 3. 技术架构设计

### 3.1 目录结构
```
Config/
├── Proxy/
│   ├── .gitignore
│   └── example.yaml          # 示例配置文件
```

### 3.2 配置文件格式
```yaml
version: 200
enable: true

proxyList:
  - name: "默认代理"
    nameEng: "default-proxy"
    type: "https"  # http, https, socks5
    host: "proxy.example.com"
    port: 8080
    username: ""  # 可选
    password: ""  # 可选
    priority: 1   # 优先级，数字越小优先级越高
    enable: true
    
    # 健康检查配置
    healthCheck:
      enable: true
      interval: 300  # 检查间隔（秒）
      timeout: 10    # 超时时间（秒）
      testUrls:      # 测试URL列表
        - "https://www.google.com"
        - "https://www.youtube.com"
        - "https://www.facebook.com"
```

### 3.3 核心类设计

#### 3.3.1 配置数据类
- `ProxyConfig`: 代理服务器配置主类
- `ProxyServer`: 单个代理服务器配置
- `HealthCheckConfig`: 健康检查配置

#### 3.3.2 服务类
- `ProxyConfigService`: 配置加载和管理服务
- `ProxyHealthCheckService`: 健康检查服务
- `ProxyStatusService`: 代理状态管理服务

#### 3.3.3 定时任务
- `ProxyHealthCheckScheduler`: 定期健康检查任务

#### 3.3.4 控制器
- `ProxyController`: 代理服务器查询接口

## 4. 实现方案

### 4.1 配置加载
使用Jackson YAML解析器加载配置文件，与现有Bot配置加载方式保持一致。

### 4.2 健康检查实现
- 使用Java HttpClient配置代理进行连接测试
- 支持异步并发检查多个代理服务器
- 记录检查结果和响应时间

### 4.3 状态管理
- 使用ConcurrentHashMap存储代理服务器状态
- 支持状态持久化（可选）
- 提供状态查询和统计功能

### 4.4 API接口设计
```kotlin
GET /api/proxy/servers          # 获取所有代理服务器状态
GET /api/proxy/servers/{name}   # 获取指定代理服务器状态
GET /api/proxy/status           # 获取代理服务器总体状态
```

## 5. 集成考虑

### 5.1 与现有系统集成
- 复用现有的日志系统（Slf4jKt）
- 复用现有的定时任务框架（@Scheduled）
- 复用现有的配置加载模式

### 5.2 扩展性考虑
- 支持动态添加/删除代理服务器
- 支持代理服务器分组
- 支持代理服务器负载均衡

## 6. 测试策略

### 6.1 功能测试
- 配置文件加载测试
- 健康检查功能测试
- API接口测试

### 6.2 集成测试
- 与现有系统集成测试
- 多代理服务器并发测试

## 7. 部署和配置

### 7.1 配置文件位置
- 主配置文件：`Config/Proxy/proxy.yaml`
- 示例文件：`Config/Proxy/example.yaml`

### 7.2 默认配置
- 健康检查间隔：5分钟
- 超时时间：10秒
- 默认测试URL：Google、YouTube、Facebook

## 8. 风险和控制

### 8.1 风险点
- 代理服务器连接失败影响系统性能
- 健康检查可能触发防火墙告警
- 代理服务器认证信息安全

### 8.2 控制措施
- 添加连接超时和重试机制
- 健康检查频率可配置
- 敏感信息加密存储（可选）

## 9. 后续优化方向

### 9.1 功能增强
- 代理服务器自动切换
- 代理服务器性能统计
- 代理服务器黑白名单

### 9.2 监控告警
- 代理服务器异常告警
- 性能指标监控
- 使用统计报表

---
**文档版本**: 1.0  
**创建时间**: 2025-09-26  
**创建人**: Roo AI Assistant