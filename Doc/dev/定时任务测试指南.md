# 定时任务测试指南

## 定时任务实现位置

定时任务在以下文件中实现：

### 1. ReportSchedulerService.kt
- **位置**: `src/main/kotlin/com/khm/group/center/task/ReportSchedulerService.kt`
- **功能**: 包含所有定时推送任务的调度逻辑

### 2. ReportPushController.kt
- **位置**: `src/main/kotlin/com/khm/group/center/controller/api/web/admin/ReportPushController.kt`
- **功能**: 提供手动触发推送的API接口，用于测试

## 定时任务配置

### 自动定时任务
- **昨日日报**: 每天早上8点 (`0 0 8 * * ?`)
- **周报**: 每周一早上9点 (`0 0 9 ? * MON`)
- **月报**: 每月1号早上10点 (`0 0 10 1 * ?`)
- **年报**: 每年1月1号早上11点 (`0 0 11 1 1 ?`)
- **缓存更新**: 每小时执行一次 (`fixedRate = 3600000`)

## 简单测试方法

### 方法1: 使用API接口手动触发（推荐）

启动应用后，访问以下API端点：

```bash
# 立即推送今日日报
POST http://localhost:8080/api/admin/report/push/today/now

# 立即推送昨日日报
POST http://localhost:8080/api/admin/report/push/yesterday/now

# 立即推送周报
POST http://localhost:8080/api/admin/report/push/weekly/now

# 立即推送月报
POST http://localhost:8080/api/admin/report/push/monthly/now

# 立即推送年报
POST http://localhost:8080/api/admin/report/push/yearly/now

# 更新统计缓存
POST http://localhost:8080/api/admin/report/push/update-cache
```

### 方法2: 使用curl命令测试

```bash
# 推送昨日日报
curl -X POST http://localhost:8080/api/admin/report/push/yesterday/now

# 推送周报
curl -X POST http://localhost:8080/api/admin/report/push/weekly/now

# 推送月报
curl -X POST http://localhost:8080/api/admin/report/push/monthly/now
```

### 方法3: 使用Postman或浏览器插件

1. 设置请求方法为 `POST`
2. 输入对应的URL
3. 发送请求

## 测试步骤

### 1. 启动应用
```bash
./gradlew bootRun
```

### 2. 测试单个推送
```bash
# 测试昨日日报推送
curl -X POST http://localhost:8080/api/admin/report/push/yesterday/now
```

### 3. 查看日志输出
在应用日志中查看推送结果：
- 成功: `✅ Yesterday report pushed successfully`
- 失败: `❌ Failed to generate yesterday report: [错误信息]`

### 4. 验证缓存功能
连续调用两次相同的API，观察日志：
- 第一次: `🔄 缓存未命中，重新计算日报`
- 第二次: `✅ 缓存命中，从缓存获取日报`

## 预期结果

### 成功响应
```json
{
  "result": {
    "message": "Yesterday report pushed successfully",
    "status": "completed"
  }
}
```

### 日志输出
```
✅ Yesterday report pushed successfully
🔄 缓存未命中，重新计算日报（2024-10-08）
💾 新日报已缓存（2024-10-08）
✅ 缓存命中，从缓存获取日报（2024-10-08）
```

## 故障排除

### 1. 定时任务不执行
- 检查Spring Boot是否启用了定时任务注解 `@EnableScheduling`
- 检查应用配置文件中的定时任务配置

### 2. API调用失败
- 确认应用已启动并监听8080端口
- 检查网络连接
- 查看应用日志中的错误信息

### 3. 推送失败
- 检查Bot配置是否正确
- 确认网络连接正常
- 查看BotPushService的日志输出

## 快速测试脚本

创建一个简单的测试脚本 `test_push.sh`：

```bash
#!/bin/bash

BASE_URL="http://localhost:8080/api/admin/report/push"

echo "测试昨日日报推送..."
curl -X POST $BASE_URL/yesterday/now

echo ""
echo "测试周报推送..."
curl -X POST $BASE_URL/weekly/now

echo ""
echo "测试缓存更新..."
curl -X POST $BASE_URL/update-cache
```

运行脚本：
```bash
chmod +x test_push.sh
./test_push.sh
```

这个指南提供了最简单直接的测试方法，你可以立即开始测试定时推送功能。