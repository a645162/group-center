# 报告推送功能使用说明

## 功能概述

本系统使用Spring Boot内置的`@Scheduled`实现了周期性的报告推送功能，支持将GPU使用统计报告推送到飞书和企业微信群。系统包含三种类型的群组：

1. **报警群 (alarm)** - 用于接收系统报警和重要通知
2. **短期群 (shortterm)** - 用于接收日报和周报
3. **长期群 (longterm)** - 用于接收月报和年报

## 配置步骤

### 1. 配置Bot信息

复制示例配置文件并填写实际的bot信息：

```bash
cp Config/Bot/bot-groups-example.yaml Config/Bot/bot-groups.yaml
```

编辑 `Config/Bot/bot-groups.yaml` 文件，填写飞书和企业微信的bot配置：

```yaml
bot:
  groups:
    - name: "报警群(管理员)"
      type: "alarm"
      weComGroupBotKey: "企业微信报警群机器人key"
      larkGroupBotId: "飞书报警群机器人ID"
      larkGroupBotKey: "飞书报警群机器人密钥"
      enable: true

    - name: "日/周报群"
      type: "shortterm"
      weComGroupBotKey: "企业微信日报群机器人key"
      larkGroupBotId: "飞书日报群机器人ID"
      larkGroupBotKey: "飞书日报群机器人密钥"
      enable: true

    - name: "年/月报群"
      type: "longterm"
      weComGroupBotKey: "企业微信月报群机器人key"
      larkGroupBotId: "飞书月报群机器人ID"
      larkGroupBotKey: "飞书月报群机器人密钥"
      enable: true
```

### 2. 获取飞书Bot信息

1. 在飞书开放平台创建企业自建应用
2. 启用机器人功能
3. 获取webhook地址中的bot ID和密钥
4. 将配置填入yaml文件

### 3. 定时任务配置

系统自动配置了以下定时任务：

- **日报**: 每天早上8点推送 (cron: `0 0 8 * * ?`)
- **周报**: 每周一早上9点推送 (cron: `0 0 9 ? * MON`)
- **月报**: 每月1号早上10点推送 (cron: `0 0 10 1 * ?`)
- **年报**: 每年1月1号早上11点推送 (cron: `0 0 11 1 1 ?`)
- **缓存更新**: 每小时更新统计缓存
- **补推检查**: 每天凌晨5点检查并补推缺失的报告 (cron: `0 0 5 * * ?`)

## API接口

系统提供了手动触发报告的RESTful接口：

### 立即推送日报
```bash
POST /api/admin/report/push/daily/now
```

### 立即推送周报
```bash
POST /api/admin/report/push/weekly/now
```

### 立即推送月报
```bash
POST /api/admin/report/push/monthly/now
```

### 立即推送年报
```bash
POST /api/admin/report/push/yearly/now
```

### 检查并补推缺失报告
```bash
POST /api/admin/report/push/check-missing
```

### 更新统计缓存
```bash
POST /api/admin/report/push/update-cache
```

## 报告内容

### 日报内容
- 总任务数
- 总运行时间
- 活跃用户数
- 任务成功率
- 今日Top用户
- 今日Top GPU

### 周报内容  
- 总任务数
- 总运行时间
- 活跃用户数
- 本周Top用户
- 本周Top GPU
- 每日趋势

### 月报内容
- 总任务数
- 总运行时间
- 活跃用户数
- 本月Top用户
- 本月Top GPU
- 本月Top项目
- 每周趋势

### 年报内容
- 总任务数
- 总运行时间
- 活跃用户数
- 年度Top用户
- 年度Top GPU
- 年度Top项目
- 每月趋势

## 故障恢复

系统会自动记录报告推送状态，并在每天凌晨5点检查是否有缺失的报告。如果发现某天的报告未推送，会自动进行补推。

推送状态文件保存在 `Config/Program/Report/` 目录下，格式为：
- `daily_2025-09-05.toml`
- `weekly_2025-09-05.toml`
- `monthly_2025-09.toml`
- `yearly_2025.toml`

## 调度方案变更

系统已从JobRunr迁移到Spring Boot内置的`@Scheduled`调度方案，主要变更包括：

1. **移除依赖**: 不再需要JobRunr相关依赖
2. **简化配置**: 不再需要JobRunr的数据库表配置
3. **统一管理**: 所有调度任务统一由Spring Boot管理
4. **Cron表达式**: 使用标准的Spring Cron表达式格式

新的调度方案更加轻量级，无需额外的数据库表，部署和维护更加简单。

## 测试方法

### 1. 配置文件测试
```bash
cd Scripts
kotlin test-report-push.kt
```

### 2. 手动触发测试
使用API接口手动触发报告推送，查看控制台输出确认推送状态。

### 3. 完整测试流程
1. 配置正确的bot信息
2. 启动应用
3. 调用测试接口触发报告推送
4. 检查飞书/企业微信群是否收到消息
5. 检查推送状态文件是否正确生成

## 注意事项

1. 确保 `Config/Bot/bot-groups.yaml` 文件存在且格式正确
2. 飞书bot需要正确的权限配置
3. 系统时区设置为 Asia/Shanghai (UTC+8)
4. 推送失败会在控制台输出错误信息
5. 报告数据依赖于GPU任务数据的完整性