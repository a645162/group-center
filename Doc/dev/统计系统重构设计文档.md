# 统计系统重构设计文档

## 1. 需求分析

### 1.1 当前问题
- 现有统计系统将缓存逻辑与业务逻辑耦合在 `StatisticsService` 中
- 缺乏灵活的自定义时间段统计功能
- 需要添加熬夜/早起时间分析功能

### 1.2 重构目标
1. **抽象无缓存方案**：创建基础统计服务接口，专注于业务逻辑
2. **缓存方案包装**：在无缓存方案基础上添加缓存层
3. **自定义时间段支持**：提供灵活的时间段统计接口
4. **熬夜/早起分析**：添加基于凌晨4点为界的作息时间分析

## 2. 架构设计

### 2.1 分层架构
```
┌─────────────────┐
│   Controller层   │ ← 对外API接口
├─────────────────┤
│   缓存服务层      │ ← 缓存包装器，调用基础服务
├─────────────────┤
│   基础服务层      │ ← 无缓存的核心业务逻辑
├─────────────────┤
│   分析器层       │ ← 统计分析算法
├─────────────────┤
│   数据访问层     │ ← 数据库查询
└─────────────────┘
```

### 2.2 核心组件设计

#### 2.2.1 基础统计服务接口 (`BaseStatisticsService`)
```kotlin
interface BaseStatisticsService {
    // 基础统计方法（无缓存）
    fun getUserStatistics(tasks: List<GpuTaskInfoModel>, startTime: Long?, endTime: Long?): List<UserStatistics>
    fun getGpuStatistics(tasks: List<GpuTaskInfoModel>, startTime: Long?, endTime: Long?): List<GpuStatistics>
    // ... 其他统计方法
    
    // 自定义时间段统计
    fun getCustomPeriodStatistics(startTime: Long, endTime: Long): CustomPeriodStatistics
}
```

#### 2.2.2 缓存统计服务 (`CachedStatisticsService`)
```kotlin
class CachedStatisticsService(
    private val baseService: BaseStatisticsService,
    private val cacheManager: CacheManager
) {
    // 包装基础服务，添加缓存逻辑
    // 现有统计API使用此服务
}
```

#### 2.2.3 时间分析工具类 (`TimeAnalysisUtils`)
```kotlin
class TimeAnalysisUtils {
    // 判断是否为熬夜（超过12点，没到凌晨4点）
    fun isLateNight(startTime: Long): Boolean
    
    // 判断是否为早起（超过4点，没到上午10点）
    fun isEarlyMorning(startTime: Long): Boolean
    
    // 获取熬夜冠军（最晚启动时间）
    fun getLateNightChampion(tasks: List<GpuTaskInfoModel>): GpuTaskInfoModel?
    
    // 获取早起冠军（最早启动时间）
    fun getEarlyMorningChampion(tasks: List<GpuTaskInfoModel>): GpuTaskInfoModel?
    
    // 获取熬夜任务列表
    fun getLateNightTasks(tasks: List<GpuTaskInfoModel>): List<GpuTaskInfoModel>
    
    // 获取早起任务列表
    fun getEarlyMorningTasks(tasks: List<GpuTaskInfoModel>): List<GpuTaskInfoModel>
}
```

## 3. 接口设计

### 3.1 新增API接口

#### 3.1.1 自定义时间段统计
```kotlin
@GetMapping("/custom")
fun getCustomPeriodStatistics(
    @RequestParam @DateTimeFormat(iso = DateTimeFormat.ISO.DATE_TIME) startTime: LocalDateTime,
    @RequestParam @DateTimeFormat(iso = DateTimeFormat.ISO.DATE_TIME) endTime: LocalDateTime
): ClientResponse
```

#### 3.1.2 作息时间分析
```kotlin
@GetMapping("/sleep-analysis")
fun getSleepAnalysis(
    @RequestParam(defaultValue = "ONE_WEEK") timePeriod: String
): ClientResponse
```

### 3.2 数据结构扩展

#### 3.2.1 自定义时间段统计结果
```kotlin
data class CustomPeriodStatistics(
    val startTime: LocalDateTime,
    val endTime: LocalDateTime,
    val userStats: List<UserStatistics>,
    val gpuStats: List<GpuStatistics>,
    val sleepAnalysis: SleepAnalysis? // 作息分析结果
)
```

#### 3.2.2 作息分析结果
```kotlin
data class SleepAnalysis(
    val lateNightTasks: List<GpuTaskInfoModel>,
    val earlyMorningTasks: List<GpuTaskInfoModel>,
    val lateNightChampion: GpuTaskInfoModel?, // 熬夜冠军
    val earlyMorningChampion: GpuTaskInfoModel?, // 早起冠军
    val totalLateNightTasks: Int,
    val totalEarlyMorningTasks: Int
)
```

## 4. 实现方案

### 4.1 重构步骤

1. **创建基础接口**：定义无缓存的基础统计服务
2. **重构分析器**：将 `StatisticsAnalyzer` 重构为无缓存版本
3. **实现基础服务**：创建 `BaseStatisticsServiceImpl` 实现基础接口
4. **创建缓存服务**：实现 `CachedStatisticsService` 包装器
5. **添加时间分析**：实现 `TimeAnalysisUtils` 工具类
6. **更新控制器**：修改 `StatisticsController` 使用新架构
7. **添加新接口**：实现自定义时间段和作息分析API

### 4.2 关键实现细节

#### 4.2.1 时间边界定义
- **熬夜**：00:00-04:00 之间启动的任务
- **早起**：04:00-10:00 之间启动的任务
- **正常**：10:00-24:00 之间启动的任务

#### 4.2.2 缓存策略
- 基础服务：无缓存，直接进行数据分析
- 缓存服务：使用现有缓存机制，缓存时间可配置
- 自定义时间段统计：根据时间段生成缓存键，避免重复计算

## 5. 迁移计划

### 5.1 阶段一：基础架构搭建
- 创建基础接口和工具类
- 保持现有功能不变

### 5.2 阶段二：服务重构
- 重构现有服务为无缓存版本
- 创建缓存包装器

### 5.3 阶段三：功能扩展
- 添加新API接口
- 集成作息时间分析功能

### 5.4 阶段四：测试验证
- 功能测试
- 性能测试
- 兼容性验证

## 6. 风险评估

### 6.1 技术风险
- 现有API的兼容性需要保证
- 缓存机制的正确性需要验证

### 6.2 缓解措施
- 逐步迁移，分阶段实施
- 充分的单元测试和集成测试
- 保留回滚方案

## 7. 预期收益

1. **代码解耦**：业务逻辑与缓存逻辑分离
2. **扩展性增强**：易于添加新的统计功能
3. **灵活性提升**：支持自定义时间段统计
4. **功能丰富**：新增作息时间分析功能
5. **维护性改善**：清晰的架构分层，便于维护

## 8. 后续优化方向

1. 支持更复杂的时间段组合统计
2. 添加实时统计功能
3. 支持统计数据的导出和可视化
4. 添加预警和异常检测功能