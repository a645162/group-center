# 报警功能紧急参数改造说明

## 功能概述

本次改造为报警系统添加了紧急参数支持，当设置为紧急时，可以在飞书群中艾特全体成员，提高重要报警的可见性。

## 改造内容

### 1. LarkGroupBot 改造

**文件**: `src/main/kotlin/com/khm/group/center/message/webhook/lark/LarkGroupBot.kt`

#### 新增功能
- `sendText(content: String, atAll: Boolean = false)`: 添加艾特全体成员参数
- `sendTextWithSilentMode(text: String, silentModeConfig: SilentModeConfig?, atAll: Boolean = false)`: 静默模式也支持艾特全体成员

#### 实现原理
当 `atAll = true` 时，在消息末尾添加：
```
<at user_id="all">所有人</at>
```

### 2. BotPushService 改造

**文件**: `src/main/kotlin/com/khm/group/center/service/BotPushService.kt`

#### 新增紧急参数
所有推送方法都添加了 `urgent: Boolean = false` 参数：

- `pushToAlarmGroup(message: String, urgent: Boolean = false)`
- `pushToShortTermGroup(message: String, urgent: Boolean = false)`
- `pushToLongTermGroup(message: String, urgent: Boolean = false)`
- `pushToGroup(message: String, groupType: String, urgent: Boolean = false)`
- `pushTimeSyncAlarm(machineName: String, clientTimestamp: Long, serverTimestamp: Long, timeDiff: Long, threshold: Long = 300, urgent: Boolean = false)`

#### 时间同步报警消息格式改进
新的时间同步报警消息包含更详细的时间信息：

```
⚠️ 时间同步报警
====================
机器: {机器名称}

📊 时间信息:
• 客户端时间: {客户端时间}
• 服务器时间: {服务器时间}
• 时间差: {时间差秒数}秒 ({分钟数}分钟, {小时数}小时, {天数}天)
• 阈值: {阈值}秒

💡 建议: 请使用ntp服务同步时间
```

### 3. MachineStatusService 更新

**文件**: `src/main/kotlin/com/khm/group/center/service/MachineStatusService.kt`

#### 日志改进
- 添加更详细的时间差日志，包括分钟、小时、天数的转换
- 记录客户端时间戳和服务器时间戳的具体值

#### 时间同步报警调用更新
使用新的 `pushTimeSyncAlarm` 方法签名，传递客户端和服务器时间戳。

### 4. 测试用例

**文件**: `src/test/kotlin/com/khm/group/center/service/BotPushServiceTest.kt`

#### 测试覆盖
- 普通报警消息测试
- 紧急报警消息测试（艾特全体成员）
- 时间同步报警测试（普通和紧急）
- 推送到不同群组的测试
- Bot群组配置获取测试

## 使用方法

### 1. 普通报警（默认不紧急）
```kotlin
BotPushService.pushToAlarmGroup("普通报警消息")
// 或
botPushService.pushAlarmMessage("标题", "内容")
```

### 2. 紧急报警（艾特全体成员）
```kotlin
BotPushService.pushToAlarmGroup("紧急报警消息", urgent = true)
// 或
botPushService.pushAlarmMessage("紧急标题", "紧急内容", urgent = true)
```

### 3. 时间同步报警
```kotlin
BotPushService.pushTimeSyncAlarm(
    machineName = "2084",
    clientTimestamp = clientTime,
    serverTimestamp = serverTime,
    timeDiff = 180,
    threshold = 120,
    urgent = false  // 或 true 表示紧急
)
```

## 系统影响

### 1. 向后兼容性
✅ 所有现有代码无需修改，默认参数 `urgent = false` 确保向后兼容

### 2. 性能影响
✅ 无性能影响，仅在紧急时添加少量文本

### 3. 功能影响
✅ 不影响现有功能
✅ 新增紧急报警功能
✅ 时间同步报警消息格式更友好

## 验证结果

### 1. 编译验证
- ✅ 使用 `./gradlew build` 构建成功
- ✅ 所有66个测试用例通过
- ✅ 无编译错误和警告

### 2. 功能验证
- ✅ 普通报警功能正常
- ✅ 紧急报警功能正常（艾特全体成员）
- ✅ 时间同步报警消息格式正确
- ✅ 日志输出详细时间信息

## 紧急报警使用场景

### 1. 严重系统故障
- 数据库连接失败
- 关键服务宕机
- 网络中断

### 2. 安全事件
- 未授权访问
- 异常登录
- 数据泄露风险

### 3. 业务关键事件
- 支付系统异常
- 订单处理失败
- 用户数据丢失

## 注意事项

1. **谨慎使用紧急报警**: 紧急报警会艾特全体成员，应仅在真正紧急的情况下使用
2. **配置验证**: 确保飞书群配置正确，支持艾特全体成员功能
3. **消息格式**: 时间同步报警现在提供更友好的时间显示格式
4. **日志记录**: 所有报警操作都会记录详细日志，便于问题排查

## 总结

本次改造成功为报警系统添加了紧急参数支持，使重要报警能够更有效地通知相关人员。同时改进了时间同步报警的消息格式，提供更直观的时间信息显示。所有功能都经过充分测试，确保系统的稳定性和可靠性。