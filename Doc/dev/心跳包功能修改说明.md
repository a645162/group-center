# 心跳包功能修改说明

## 修改概述

本次修改对心跳包处理逻辑进行了以下重要调整：

### 1. 时间差检测逻辑优化
- **修改前**: 时间差超过5分钟（300秒）记录警告
- **修改后**: 时间差超过2分钟（120秒）记录警告并推送报警
- **报警推送**: 自动推送到报警群，提醒时间同步问题

### 2. 离线检测逻辑调整
- **修改前**: 超过1小时无心跳标记为离线
- **修改后**: 超过2小时无心跳标记为离线
- **报警推送**: 离线时自动推送到报警群

### 3. 定时任务频率优化
- **修改前**: 每10分钟执行一次ping检测和状态清理
- **修改后**: 每5分钟执行一次ping检测和状态清理
- **优势**: 更及时的状态检测和报警

## 核心代码修改

### MachineStatusService.kt

#### 时间差检测逻辑
```kotlin
// 时间戳验证：如果时间相差超过2分钟，记录警告并推送报警
if (timeDiff > 120) { // 2分钟 = 120秒
    logger.warn("Machine ${machine.nameEng} timestamp difference is large: ${timeDiff} seconds, may need time synchronization")
    // 推送时间同步报警到报警群
    BotPushService.pushTimeSyncAlarm(machine.nameEng, timeDiff, 120)
}
```

#### 离线检测逻辑
```kotlin
// 清理过期状态（超过2小时无心跳的机器标记为离线并推送报警）
if (timeDiff > 7200) { // 2小时 = 7200秒
    status.agentStatus = false
    expiredMachines.add(nameEng)
    
    // 更新MachineConfig中的状态
    val machine = MachineConfig.getMachineByNameEng(nameEng)
    machine?.agentStatus = false
    
    // 推送到报警群
    offlineMachines.add(nameEng)
}
```

#### 在线状态检查
```kotlin
/**
 * 检查agent是否在线（最近2分钟内有心跳）
 */
fun isAgentOnline(serverNameEng: String): Boolean {
    val status = machineStatusMap[serverNameEng] ?: return false
    val lastHeartbeat = status.lastHeartbeatTime ?: return false
    
    val currentTime = DateTimeUtils.getCurrentTimestamp()
    return (currentTime - lastHeartbeat) <= 120 // 2分钟
}
```

### MachinePingScheduler.kt

#### 定时任务频率
```kotlin
/**
 * 每5分钟执行一次ping检测
 */
@Scheduled(fixedRate = 300000) // 5分钟 = 300000毫秒
fun scheduledPing() {

/**
 * 每5分钟执行一次状态清理（清理过期状态）
 */
@Scheduled(fixedRate = 300000) // 5分钟 = 300000毫秒
fun scheduledCleanup() {
```

## 报警推送功能

### 时间同步报警
- 当检测到时间差超过2分钟时，自动推送报警到报警群
- 报警内容包括：机器名称、时间差、阈值、建议解决方案

### 离线状态报警
- 当机器超过2小时无心跳被标记为离线时，自动推送报警
- 报警内容包括：离线机器列表、离线时长、建议检查事项

## 功能特点

1. **实时监控**: 每5分钟检查一次机器状态
2. **智能报警**: 根据时间差和离线状态自动推送报警
3. **灵活配置**: 时间阈值可根据需求调整
4. **日志记录**: 详细的日志记录便于问题排查
5. **状态同步**: 状态信息同步更新到MachineConfig

## 使用建议

1. **时间同步**: 建议所有机器使用NTP服务同步时间
2. **网络检查**: 定期检查网络连接状态
3. **报警配置**: 确保报警群配置正确，能够及时接收报警信息
4. **日志监控**: 定期查看系统日志，了解机器状态变化

## 后续优化

1. 可以考虑添加更多的报警方式（邮件、短信等）
2. 可以增加机器状态的历史记录和统计分析
3. 可以添加机器自动恢复功能